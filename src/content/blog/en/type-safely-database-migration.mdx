---
title: 'Type-Safely database migration on Cloudflare D1 with Drizzle ORM'
date: 2023-05-24
authors:
    - en/inurhuda00
desc: introduce that Drizzle ORM makes you type-safe
topics:
    - docs
tags:
    - sqlite
    - orm
    - drizzle
---

[Previous post](/posts/drizzle-intro), I introduce that Drizzle ORM makes you type-safe database access on Cloudflare D1. In this post, I will show you how to migrate your database schema with Drizzle Kit.

The tasks table that you might create in previous has the following four columns

-   id
-   title
-   description
-   completion_at

In this tutorial, demonstrating how to add columns to the table with [Drizzle](https://github.com/drizzle-team/drizzle-orm).

# Add a priority column to tasks table

1. Open `db/schema/tasks.ts` and add a priority field.

    ```ts title="db/schema/tasks.ts" {1-3} caption="this is caption "
    import { integer, sqliteTable, text } from 'drizzle-orm/sqlite-core'

    export const tasks = sqliteTable('tasks', {
    	id: integer('id').primaryKey(),
    	title: text('title').notNull(),
    	description: text('description').notNull(),
    	comletionAt: integer('completion_at', { mode: 'timestamp' }),
    	priority: text('number').notNull().default('0'), // ← Add this line
    })
    ```

1. Generate a migration with `Drizzle Kit`

    ```bash title="terminal"
    npx drizzle-kit generate:sqlite --schema=./db/schema/index.ts --out=./migrations
    ```

    After running the command, open the migration file and you should see the following:

    ```bash title="terminal"
    cat migrations/0001_strong_gorgon.sql
    ALTER TABLE tasks ADD `priority` integer DEFAULT 0 NOT NULL;
    ```

1. Run a migration with Wrangler

    First, Check the list of unapplied migrations:

    ```bash title="terminal"
    npx wrangler d1 migrations list <DATABASE_NAME> --local
    ```

    Then, you should see the following output:

    ```bash title="terminal"
    Migrations to be applied:
    ┌────────────────────────┐
    │ Name                   │
    ├────────────────────────┤
    │ 0001_strong_gorgon.sql │
    └────────────────────────┘
    ```

    Apply migration:

    ```bash title="terminal"
    npx wrangler d1 migrations apply <DATABASE_NAME> --local
    ```

## Update API

1. Add a priority to the input schema

    Copy the following code, open `functions/api/[[trpc]].ts`, and paste it.

    <details>

    <summary>Show code</summary>

    ```tsx title="functions/api/[[trpc]].ts"
    import { inferAsyncReturnType, initTRPC } from '@trpc/server'
    import tRPCPagesPluginFunction, { FetchCreateContextWithCloudflareEnvFnOptions } from 'cloudflare-pages-plugin-trpc'
    import { drizzle } from 'drizzle-orm/d1'
    import { eq } from 'drizzle-orm/expressions'
    import { z } from 'zod'

    import { tasks } from '../../db/schema'

    // Declare d1 binding as interface
    // Key is same as d1_databases.binding on wrangler.toml
    interface Env {
    	DB: D1Database
    }

    // Map binding to context of tRPC
    const createContext = async ({ env }: FetchCreateContextWithCloudflareEnvFnOptions<Env>) => ({
    	db: drizzle(env.DB),
    })

    // Alias context type
    type Context = inferAsyncReturnType<typeof createContext>

    // Create a router instance with context
    const t = initTRPC.context<Context>().create()

    // Create routing to manage tasks
    // It provides three routes:
    //
    //   - create: Create a task
    //   - complete: Complete a task
    //   - list: Retrieve tasks not completed
    const appRouter = t.router({
    	tasks: t.router({
    		// Route to create a task
    		create: t.procedure
    			.input(
    				z.object({
    					title: z.string(),
    					description: z.string(),
    					priority: z.number(),
    				})
    			)
    			.mutation(async ({ input, ctx }) => {
    				await ctx.db
    					.insert(tasks)
    					.values({
    						title: input.title,
    						description: input.description,
    						priority: input.priority,
    					})
    					.run()
    			}),
    		// Route to complete a task
    		complete: t.procedure.input(z.object({ id: z.number() })).mutation(async ({ input, ctx }) => {
    			const result = await ctx.db
    				.update(tasks)
    				.set({
    					comletionAt: new Date(),
    				})
    				.where(eq(tasks.id, input.id))
    				.run()
    			if (!result.success) {
    				throw new Error(result.error)
    			}
    		}),
    		// Route to retrieve tasks not completed
    		list: t.procedure.query(async ({ ctx }) => {
    			const result = await ctx.db.select().from(tasks).all()
    			return { tasks: result }
    		}),
    	}),
    })

    // Expose type alias of appRouter. It uses on the client
    export type AppRouter = typeof appRouter

    // Expose a request handler to run it on Cloudflare Pages Functions
    // with tRPCPagesPlugin
    export const onRequest: PagesFunction = tRPCPagesPluginFunction({
    	router: appRouter,
    	createContext,
    	endpoint: '/api/trpc',
    	onError: (error) => {
    		console.log(error)
    	},
    })
    ```

    </details>

## Update UI

### Add a priority field to the task registration form

Currently, the task registration form has a title and description field. Add a priority field and set its value to the payload of mutation.

Copy the following code, open `src/pages/NewTask.tsx`, and paste it.

   <details>

{" "}

<summary>Show code</summary>

```tsx
import { FormEvent, useCallback } from 'react'
import * as Form from '@radix-ui/react-form'
import * as RadioGroup from '@radix-ui/react-radio-group'
import { useRouter } from '@raula/router'
import { useQueryClient } from '@tanstack/react-query'
import { getQueryKey } from '@trpc/react-query'

import { Loader } from '../components/Loader'
import { useToast } from '../components/Toast'
import { trpc } from '../utils/trpc'

export const NewTaskPage = (): JSX.Element => {
	const toast = useToast()
	const { router } = useRouter()
	const createTask = trpc.tasks.create.useMutation()
	const queryClient = useQueryClient()
	const handleSubmit = useCallback(
		async (event: FormEvent<HTMLFormElement>) => {
			event.preventDefault()
			const data = Object.fromEntries(new FormData(event.currentTarget))
			await createTask.mutateAsync({
				title: data.title as string,
				description: data.description as string,
				priority: parseInt(data.priority as string),
			})
			await queryClient.invalidateQueries(getQueryKey(trpc.tasks))

			toast('Create successfully!')
			router.push('/')
		},
		[router, toast, createTask, queryClient]
	)
	return (
		<main>
			<h1 className="mb-8 text-2xl font-bold text-neutral-200">Create a new task</h1>
			<Form.Root className="space-y-10" onSubmit={handleSubmit}>
				<div className="space-y-4">
					<Form.Field className="grid" name="title">
						<div className="flex items-baseline justify-between">
							<Form.Label className="text-mauve1 font-medium leading-[35px]">Title</Form.Label>
							<Form.Message className="text-mauve1 text-sm opacity-[0.8]" match="valueMissing">
								Please enter a title
							</Form.Message>
						</div>
						<Form.Control asChild>
							<input
								className="bg-whiteA3 shadow-whiteA8 hover:shadow-whiteA9 focus:shadow-whiteA11 text-mauve1 selection:color-white selection:bg-blackA9 box-border inline-flex w-full appearance-none items-center justify-center rounded px-3 py-3 leading-none shadow-[0_0_0_1px] outline-none"
								type="text"
								required
							/>
						</Form.Control>
					</Form.Field>
					<Form.Field className="grid" name="description">
						<div className="flex items-baseline justify-between">
							<Form.Label className="text-mauve1 text-[15px] font-medium leading-[35px]">
								Description
							</Form.Label>
							<Form.Message className="text-mauve1 text-[13px] opacity-[0.8]" match="valueMissing">
								Please enter a description
							</Form.Message>
						</div>
						<Form.Control asChild>
							<textarea
								className="bg-whiteA4 shadow-whiteA8 hover:shadow-whiteA9 focus:shadow-whiteA11 text-mauve1 selection:color-white  selection:bg-blackA9 box-border inline-flex w-full resize-none appearance-none items-center justify-center rounded px-3 py-3 leading-none shadow-[0_0_0_1px] outline-none"
								required
							/>
						</Form.Control>
					</Form.Field>
					<Form.Field className="grid" name="priority">
						<div className="flex items-baseline justify-between">
							<Form.Label className="text-mauve1 text-[15px] font-medium leading-[35px]">
								Priority
							</Form.Label>
							<Form.Message className="text-mauve1 text-[13px] opacity-[0.8]" match="valueMissing">
								Please select a priority
							</Form.Message>
						</div>
						<Form.Control asChild>
							<RadioGroup.Root
								className="flex flex-col gap-2.5"
								defaultValue="0"
								aria-label="View density">
								<div className="flex items-center">
									<RadioGroup.Item
										className="shadow-blackA7 hover:bg-plum3 h-[25px] w-[25px] cursor-default rounded-full bg-white shadow-[0_2px_10px] outline-none focus:shadow-[0_0_0_2px] focus:shadow-black"
										value="0"
										id="r1">
										<RadioGroup.Indicator className="after:bg-plum11 relative flex h-full w-full items-center justify-center after:block after:h-[11px] after:w-[11px] after:rounded-[50%] after:content-['']" />
									</RadioGroup.Item>
									<label className="pl-[15px] text-[15px] leading-none text-white" htmlFor="r1">
										Default
									</label>
								</div>
								<div className="flex items-center">
									<RadioGroup.Item
										className="shadow-blackA7 hover:bg-plum3 h-[25px] w-[25px] cursor-default rounded-full bg-white shadow-[0_2px_10px] outline-none focus:shadow-[0_0_0_2px] focus:shadow-black"
										value="1"
										id="r2">
										<RadioGroup.Indicator className="after:bg-plum11 relative flex h-full w-full items-center justify-center after:block after:h-[11px] after:w-[11px] after:rounded-[50%] after:content-['']" />
									</RadioGroup.Item>
									<label className="pl-[15px] text-[15px] leading-none text-white" htmlFor="r2">
										High
									</label>
								</div>
							</RadioGroup.Root>
						</Form.Control>
					</Form.Field>
				</div>
				<Form.Submit asChild>
					<button
						className="bg-plum11 hover:bg-plum10 shadow-whiteA8 box-border flex items-center justify-center rounded px-4 py-2 text-sm leading-none text-white shadow-[0_2px_10px] disabled:cursor-not-allowed disabled:opacity-50"
						disabled={createTask.isLoading}>
						{createTask.isLoading && <Loader />}
						Create Task
					</button>
				</Form.Submit>
			</Form.Root>
		</main>
	)
}
```

   </details>

### Show the icon on a high-priority task

Copy the following code, open `src/components/Task.tsx` and paste it.

   <details>

{" "}

<summary>Show code</summary>

```tsx
import * as Checkbox from '@radix-ui/react-checkbox'
import { CheckIcon } from '@radix-ui/react-icons'

import { Task as TaskSchema } from '../../db/schema'

type Props = Pick<TaskSchema, 'title' | 'description' | 'priority'> & {
	onClick: () => void
}
export const Task = ({ title, description, priority, onClick }: Props): JSX.Element => {
	return (
		<label className="flex cursor-pointer space-x-3 py-2">
			<Checkbox.Root
				className="border-whiteA9 mt-1 flex h-5 w-5 appearance-none items-center justify-center rounded-full border text-transparent shadow-sm outline-none hover:text-slate-400"
				checked
				onCheckedChange={() => onClick()}>
				<Checkbox.Indicator className="text-inherit">
					<CheckIcon />
				</Checkbox.Indicator>
			</Checkbox.Root>
			<div>
				<h2 className="text-whiteA12 text-lg">{title}</h2>
				<ul className="text-whiteA11 flex space-x-1 text-sm">
					<li>
						{priority === 0 && <p>default</p>}
						{priority === 1 && <p>high</p>}
					</li>
					<li>
						<p>•</p>
					</li>
					<li>
						<p>{description}</p>
					</li>
				</ul>
			</div>
		</label>
	)
}
```

   </details>

## Run locally

Start development server on:

```bash title="terminal"
npx wrangler pages dev --local --persist --d1=<DATABASE_BINDING> -- npm run dev
```

Once you open your browser, you should be able to create a task with priority:

<img src="/assets/posts/drizzle-migration/local.gif" width="500" />

## Deploy to Cloudflare Page

1. Push your repository to GitHub

1. Apply a migration to Cloudflare D1

    1. Check the list of unapplied migrations:

    ```bash title="terminal"
    npx wrangler d1 migrations list <DATABASE_NAME>
    ```

    2. you should see the following output:

    ```bash title="terminal"
    Migrations to be applied:
    ┌────────────────────────┐
    │ Name                   │
    ├────────────────────────┤
    │ 0001_strong_gorgon.sql │
    └────────────────────────┘
    ```

    3. Apply migration:

    ```bash title="terminal"
    npx wrangler d1 migrations apply <DATABASE_NAME>
    ```

# Conclusion

Great, in this tutorial, you learned how to migrate your database schema using Drizzle Kit, making your database changes type-safe and secure. With Drizzle, you can easily add or modify columns in your database tables and ensure that your application continues to function correctly. Thank you!
